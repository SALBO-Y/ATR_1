# 조건검색 모니터링 테스트 시스템

한국투자증권 조건검색식을 주기적으로 실행하여 실시간 종목 발굴 타이밍을 검증하는 테스트 시스템입니다.

## 목적

실전매매 전에 조건검색식의 성능을 검증하기 위해:

1. **실시간 감시**: 조건검색식을 주기적으로 실행 (10초 단위 등)
2. **즉시 알림**: 조건에 부합하는 종목 발견 시 텔레그램으로 즉시 알림
3. **타이밍 검증**: 알림 시점부터 실제 가격 변화 추적
4. **전략 최적화**: 조건검색식과 매매 타이밍의 효과성 검증

## 주요 기능

### 1. 주기적 조건검색 실행
- 사용자 설정 주기(기본 10초)로 조건검색 자동 실행
- 실시간 감시처럼 작동

### 2. 텔레그램 즉시 알림
- 새로 조건에 편입된 종목 발견 시 즉시 알림
- 종목별 현재가, 전일대비율 표시
- 최대 10개 종목 상세 정보 제공

### 3. 가격 변화 추적
- 이전 조회 시점 대비 가격 변화 추적
- 알림 시점부터의 수익률 계산 가능
- 실제 수익 가능성 검증

### 4. 상세 로그 기록
- 모든 조회 결과 로그 파일 저장
- 종목 편입/제외 이력 기록
- 시간별 조회 결과 분석 가능

## 설치 및 설정

### 1. 필수 사항

기존 자동매매 시스템과 동일한 환경 필요:
- 한국투자증권 OpenAPI 설정 완료
- `trading_config.yaml` 설정 완료
- 텔레그램 봇 설정 (선택사항)

### 2. 추가 설정 없음

`trading_config.yaml` 파일을 그대로 사용합니다.

## 사용 방법

### 기본 실행

```bash
python test_condition_monitor.py
```

### 실행 화면

```
================================================================================
조건검색 모니터링 테스트 시스템
================================================================================

현재 설정:
  환경: DEMO
  조건검색식: (첫번째 조건 사용)
  주기: 10초
  텔레그램: 활성화
  새 종목만 알림: 예
  가격 변화 추적: 예

설정을 변경하시겠습니까? (y/N):
```

### 설정 변경 (선택사항)

실행 시 설정 변경 가능:

1. **조회 주기 변경**
   ```
   조회 주기(초) [10]: 5
   ```
   - 더 빠른 모니터링을 위해 5초로 변경 가능
   - 단, API 호출 제한 주의 (초당 거래건수)

2. **알림 방식 변경**
   ```
   새 종목만 알림? (y/N) [Y]: n
   ```
   - Y: 새로 편입된 종목만 알림 (권장)
   - N: 매번 전체 종목 알림 (메시지 많음)

### 실행 중 화면

```
================================================================================
조건검색 실행 [2026-01-14 09:35:20]
================================================================================
2026-01-14 09:35:20 [INFO] 조건검색 결과: 5개 종목

종목 알림:
🆕 새로운 조건검색 종목 발견!
━━━━━━━━━━━━━━━━━━━━━━
발견시간: 09:35:20
종목수: 2개

🔺 1. 005930
  현재가: 71,500원
  전일대비: +1.42%

🔺 2. 000660
  현재가: 128,500원
  전일대비: +2.15%

다음 조회까지 10초 대기...
```

## 텔레그램 알림 예시

### 새 종목 발견 알림

```
🆕 새로운 조건검색 종목 발견!
━━━━━━━━━━━━━━━━━━━━━━
발견시간: 09:35:20
종목수: 2개

🔺 1. 005930
  현재가: 71,500원
  전일대비: +1.42%

🔺 2. 000660
  현재가: 128,500원
  전일대비: +2.15%
```

### 가격 변화 추적 (2차 조회 시)

```
🆕 새로운 조건검색 종목 발견!
━━━━━━━━━━━━━━━━━━━━━━
발견시간: 09:35:30
종목수: 1개

🔺 1. 005930
  현재가: 72,000원
  전일대비: +2.11%
  📈 변화: +500원 (+0.70%)  ← 이전 조회 대비
```

## 활용 방법

### 1. 실시간 타이밍 검증

```
1. 시스템 실행 (주기: 10초)
2. 텔레그램에서 알림 수신
3. 알림 시간 기록 (예: 09:35:20)
4. 증권사 HTS에서 해당 종목 확인
5. 09:35:20 시점부터 가격 변화 관찰
6. 실제 매수 진입 타이밍 분석
```

### 2. 조건검색식 성능 평가

여러 조건검색식을 테스트:

```bash
# 조건검색식 A 테스트 (30분)
python test_condition_monitor.py
# 결과: 5개 종목, 평균 +2.5% 상승

# 조건검색식 B 테스트 (30분)
python test_condition_monitor.py
# 결과: 3개 종목, 평균 +1.2% 상승

→ 조건검색식 A 가 더 효과적
```

### 3. 최적 매수 타이밍 발굴

```
알림 시점: 09:35:20
+10초 (09:35:30): +0.5%
+30초 (09:35:50): +1.2%
+1분 (09:36:20): +2.5%
+5분 (09:40:20): +4.8%
+10분 (09:45:20): +3.2% (하락 시작)

→ 알림 후 5분 이내 매수가 최적
```

## 설정 옵션

### MonitorConfig 클래스

`test_condition_monitor.py` 파일 상단의 설정:

```python
class MonitorConfig:
    # 환경 설정
    ENV_MODE = "demo"  # "real" 또는 "demo"
    PRODUCT_CODE = "01"

    # 조건검색식 설정
    CONDITION_NAME = ""  # 특정 조건명 지정 (비워두면 첫번째)
    CONDITION_SEQ = ""

    # 모니터링 설정
    CHECK_INTERVAL = 10  # 조회 주기 (초)

    # 텔레그램 설정 (trading_config.yaml에서 로드)
    TELEGRAM_BOT_TOKEN = ""
    TELEGRAM_CHAT_ID = ""
    TELEGRAM_ENABLED = False

    # 종목 추적 설정
    TRACK_PRICE_CHANGE = True  # 가격 변화 추적
    ALERT_NEW_STOCKS_ONLY = True  # 새 종목만 알림
```

### 주요 설정 설명

| 설정 | 설명 | 권장값 |
|------|------|--------|
| `CHECK_INTERVAL` | 조건검색 실행 주기 (초) | 10-30초 |
| `TRACK_PRICE_CHANGE` | 이전 조회 대비 가격 변화 추적 | True |
| `ALERT_NEW_STOCKS_ONLY` | 새로 편입된 종목만 알림 | True (메시지 스팸 방지) |

## 로그 파일

### 위치
```
condition_monitor_YYYYMMDD.log
```

### 내용
- 조건검색 실행 시간
- 조회된 종목 목록
- 종목별 가격 정보
- 새로 편입/제외된 종목
- 오류 메시지

### 예시
```
2026-01-14 09:35:20 [INFO] 조건검색 실행 (seq: 12345)
2026-01-14 09:35:21 [INFO] 조건검색 결과: 5개 종목
2026-01-14 09:35:21 [INFO] 새로 편입된 종목: 2개 - {'005930', '000660'}
2026-01-14 09:35:21 [INFO] 제외된 종목: 1개 - {'035720'}
```

## 주의사항

### 1. API 호출 제한

- **초당 거래건수 제한** 존재
- 조회 주기를 너무 짧게 설정하지 말 것 (최소 5초 권장)
- 종목 수가 많으면 현재가 조회에 시간 소요

### 2. 장 운영 시간

- 장 시작 전/후에는 조건검색 결과가 없을 수 있음
- 정규장 시간대(09:00-15:30)에 테스트 권장

### 3. 텔레그램 메시지

- 종목이 많으면 메시지가 많아질 수 있음
- `ALERT_NEW_STOCKS_ONLY = True` 설정 권장
- 최대 10개 종목까지만 상세 정보 표시

### 4. 실전 투자 주의

- **이 시스템은 테스트 목적**입니다
- 실전 매매는 충분한 검증 후 진행
- 알림 시점과 실제 매수 시점의 가격 차이 고려

## 종료 방법

```bash
Ctrl + C
```

시스템이 안전하게 종료되며 텔레그램으로 종료 알림이 전송됩니다.

## 트러블슈팅

### 1. 조건검색 결과가 없음

**원인:**
- 조건검색식이 HTS에 저장되지 않음
- 조건검색식이 너무 엄격함
- 장 시간 외

**해결:**
- HTS에서 조건검색식 확인
- "사용자조건 서버저장" 클릭
- 조건 완화하여 테스트

### 2. 텔레그램 알림이 오지 않음

**원인:**
- `TELEGRAM_ENABLED = False`
- 봇 토큰/채팅 ID 오류

**해결:**
- `trading_config.yaml`에서 `telegram_enabled: true` 확인
- 봇 토큰과 채팅 ID 재확인

### 3. API 오류 (EGW00201)

**원인:**
- 초당 거래건수 초과

**해결:**
- `CHECK_INTERVAL` 늘리기 (예: 30초)
- 종목 수가 많으면 현재가 조회 시간 고려

## 활용 시나리오

### 시나리오 1: 단기 급등주 포착

```
목표: 급등 초기 진입 타이밍 발굴

1. 조건검색식: 거래량 급증 + 가격 상승
2. 주기: 10초
3. 알림 수신 → 즉시 HTS 확인
4. 차트 패턴 확인 후 매수 판단
5. 수익률 기록 및 분석
```

### 시나리오 2: 조건검색식 비교

```
목표: 여러 조건검색식 중 최적 선택

1. 조건검색식 A: 30분 테스트
   - 발견 종목: 10개
   - 평균 수익률: +2.5%

2. 조건검색식 B: 30분 테스트
   - 발견 종목: 5개
   - 평균 수익률: +4.8%

3. 결론: B가 더 효과적
```

### 시나리오 3: 매수 타이밍 최적화

```
목표: 알림 후 몇 분 뒤 매수가 최적인지 분석

1. 알림 시점 기록
2. 1분, 3분, 5분, 10분 후 가격 추적
3. 패턴 분석
4. 최적 타이밍 도출
```

## 실전 적용 가이드

### 1단계: 검증 (1-2주)

```bash
python test_condition_monitor.py
```
- 조건검색식 성능 평가
- 알림 타이밍과 실제 수익 상관관계 분석
- 로그 파일 분석

### 2단계: 최적화

- 효과적인 조건검색식 선별
- 최적 매수 타이밍 도출
- `auto_trading_system.py` 설정 조정

### 3단계: 모의투자

```bash
python auto_trading_system.py
```
- 검증된 조건검색식 사용
- 모의투자 계좌로 테스트
- 실제 매매 프로세스 검증

### 4단계: 실전투자

- 충분한 검증 후 실전 전환
- 소액으로 시작
- 지속적인 모니터링

## 결론

이 테스트 시스템을 통해:

1. ✅ **조건검색식 검증**: 어떤 조건이 효과적인지 확인
2. ✅ **타이밍 최적화**: 언제 매수하는 것이 최적인지 파악
3. ✅ **리스크 감소**: 실전 전 충분한 테스트로 손실 방지
4. ✅ **전략 개선**: 데이터 기반 매매 전략 수립

**실전매매 전 반드시 이 시스템으로 충분히 검증하시기 바랍니다!**

---

**제작일**: 2026-01-14
**버전**: 1.0.0
**관련 파일**: `test_condition_monitor.py`
