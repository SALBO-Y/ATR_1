[한국투자증권 자동트레이딩 시스템 구축]

[1] 주요 기능
 - 한국투자증권 서버에 저장된 내 종목검색식 기반으로 조회된 종목 스캘핑 트레이딩 실시
 - 텔레그램봇 연동하여 매수/매도 체결알림, 실시간 잔고조회, 실시간 미실현손익 조회 실시
 - REST 호출형 API를 통해 주요 기능 구현(체결통보만 웹소켓 이용)


[2] 개발사항
🧭 전체 목표 요약

목표:
한국투자증권 서버에 저장된 조건검색식 기반 자동매매(스캘핑)
REST 중심, 실시간 체결통보만 WebSocket 사용
텔레그램 봇 연동으로 체결/잔고 알림 자동화
코스피/코스닥 전용 환경

🪜 STEP 1. 개발환경 및 인증 설정
✅ 목적

API 호출을 위한 인증 체계(AppKey, AppSecret, Access Token) 세팅 및 REST 호출 테스트

📂 참고 파일
파일명	기능
rest/kis_auth.py	접근토큰 발급/갱신 샘플코드
rest/hashkey.py	Hashkey 생성 예제
oauth2/tokenP	Access Token 발급 API
oauth2/revokeP	Token 폐기 API
⚙️ 주요 포인트

Access Token 유효기간: 1일 / 6시간 경과 시 갱신 필요

5분당 1회 이상 토큰 발급 시 제한(EGW00201 초당 거래건수 초과 방지)

테스트 시 GitHub 예제:
👉 kis_auth.py

🪜 STEP 2. 조건검색식 기반 종목 필터링
✅ 목적

HTS에 저장된 조건검색식을 호출하여 실시간 투자 종목군 확보

📂 참고 파일
폴더명	파일명	기능
examples_llm/domestic_stock/psearch_title	psearch_title.py, chk_psearch_title.py	조건검색식 목록 조회
examples_llm/domestic_stock/psearch_result	psearch_result.py, chk_psearch_result.py	조건검색식 실행 및 결과 종목 조회
⚙️ 호출 순서

1️⃣ psearch_title → 조건검색식 리스트 확인
2️⃣ psearch_result → 특정 검색식 실행 → 종목코드 리스트 수신

조건검색은 REST 구조만 지원되므로 WebSocket 구독 불가

🪜 STEP 3. 실시간 체결 및 시세 수신
✅ 목적

조회된 종목의 실시간 체결, 호가 변동 감시 및 체결 통보 처리

📂 참고 파일
폴더명	파일명	기능
examples_llm/domestic_stock/ccnl_notice	ccnl_notice.py, chk_ccnl_notice.py	실시간 체결통보(WebSocket)
examples_llm/domestic_stock/ccnl_krx	ccnl_krx.py	실시간 체결가 구독
examples_llm/domestic_stock/asking_price_krx	asking_price_krx.py	실시간 호가 데이터 구독
⚙️ 참고

/oauth2/Approval API로 WebSocket 접속키 발급

실시간 체결통보는 계좌 단위 구독

전체 종목 실시간 시세 구독은 제한(FAQ #141)

🪜 STEP 4. 주문/매도/매수 실행 (REST 중심)
✅ 목적

조건검색 결과를 기반으로 시장가 자동주문 수행

📂 참고 파일
API	파일명	기능
/uapi/domestic-stock/v1/trading/order-cash	order_cash.py	현금 매수/매도 주문
/uapi/domestic-stock/v1/trading/order-rvsecncl	order_rvsecncl.py	정정/취소 주문
/uapi/domestic-stock/v1/trading/inquire-balance	inquire_balance.py	잔고조회
/uapi/domestic-stock/v1/trading/inquire-psbl-order	inquire_psbl_order.py	매수가능금액 조회
⚙️ 주의

주문은 WebSocket 불가 (REST만 가능)

hashkey는 POST Body 전송 시 필수

체결 결과는 ccnl_notice WebSocket으로 수신

🪜 STEP 5. 텔레그램 봇 연동
✅ 목적

자동매매 중 체결, 잔고, 손익 실시간 알림 발송

📂 구성 예시
항목	예시 내용
텔레그램 라이브러리	python-telegram-bot, telebot
알림 이벤트	체결통보(WebSocket), 잔고 갱신(REST 주기적 조회)
추천 구조	KIS REST 호출 결과 → 텔레그램 API 메시지 전송
🪜 STEP 6. 잔고/손익 실시간 조회
✅ 목적

매매 후 실시간 손익·보유자산 모니터링

📂 참고 API
API	설명
/uapi/domestic-stock/v1/trading/inquire-balance	잔고조회
/uapi/domestic-stock/v1/trading/inquire-balance-rlz-pl	실현손익 포함 잔고조회
/uapi/domestic-stock/v1/trading/inquire-period-profit	기간별 손익합산 조회
⚙️ 주기적 호출 주의

5초 이하 주기로 호출 시 EGW00201(초당 거래건수 초과) 발생 가능

10초~30초 주기 권장

🪜 STEP 7. 예외/장애 처리 및 로깅
✅ 목적

API 호출 오류, 토큰 만료, 체결 누락 등 예외 상황 자동복구

📂 참고 파일
파일명	기능
01_kis_errorcodes.md	오류코드 표준 정의
07_kis_hotfix.json	하드락/핫이슈 대응
05_kis_base_knowledge_data.json	자주 발생하는 오류 사례
⚙️ 권장 처리 로직

Access Token 만료(EGW00123) → 자동 재발급

거래건수 초과(EGW00201) → 0.5초 대기 후 재시도

주문 응답 실패 시 체결내역 재조회(/inquire-daily-ccld)

🪜 STEP 8. 코스피/코스닥 구분 처리
✅ 참고

REST 요청 시 fid_cond_mrkt_div_code:

J → 코스피

Q → 코스닥

실시간 구독(WebSocket) 시 시장구분 코드 지정 필요

종목코드 마스터 다운로드 참고
👉 https://github.com/koreainvestment/open-trading-api/tree/main/stocks_info

🧩 전체 요약 플로우
[STEP1] 인증 설정 (kis_auth.py)
     ↓
[STEP2] 조건검색식 조회 (psearch_title / psearch_result)
     ↓
[STEP3] 실시간 체결통보 구독 (ccnl_notice)
     ↓
[STEP4] 조건식 결과 종목 시장가 주문 (order_cash)
     ↓
[STEP5] 텔레그램 알림 발송 (python-telegram-bot)
     ↓
[STEP6] 잔고 및 손익 주기적 조회
     ↓
[STEP7] 오류·토큰 갱신 로직 구성
     ↓
[STEP8] 코스피/코스닥 구분 및 확장

🧾 추가 참고 문서
구분	문서명	역할
API 전체 목록	03_kis_api_list.md	호출가능 API 및 URL 정의
오류코드	01_kis_errorcodes.md	EGW/OPS 오류 처리 기준
시스템공지	06_kis_notice_structure.json	API 추가/변경 이력
FAQ	02_kis_faq.json	공통 질의 응답 모음
샘플코드 모음	GitHub examples_llm	실전 예제 중심 구조
✅ 결론

고객님이 구상하신 구조는 KIS OpenAPI 설계 철학에 완벽히 부합합니다.
조건검색(REST) → 시장가 주문(REST) → 체결통보(WebSocket) → 잔고/손익/텔레그램 연동 순으로 구성하시면 안정적이며 실시간성도 확보됩니다.