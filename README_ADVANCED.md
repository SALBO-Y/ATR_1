# 고급 스캘핑 자동매매 시스템 (Advanced Scalping Bot)

## 🎯 전략 개요

**Multi-Layer Filtering + Dynamic Exit Strategy**

AI 트레이딩 및 월가 전문가 관점에서 설계된 5단계 고급 스캘핑 전략입니다.

## 📊 전략 구조

### TIER 1: 종목 유니버스 필터링 (일일 1회)
**목표: 거래 가능한 우량 종목군 선별 (30~50종목)**

#### 1.1 기본 적격성
- ✅ 시가총액: **500억 이상** (유동성 확보)
- ✅ 일평균 거래대금: **50억 이상**
- ✅ 주가: **5,000원~500,000원** (극단 제외)
- ✅ 상장 후 **3개월 이상**

#### 1.2 추세 강도 필터
- ✅ **일봉 MA20 > MA60 > MA120** (명확한 상승 추세)
- ✅ **ADX(14) > 25** (추세 강도 확인)
- ✅ **15분봉 MA50 > MA200** (골든크로스)
- ✅ **RSI(14): 40~70 구간** (과매도/과매수 배제)

#### 1.3 모멘텀 확인
- ✅ 5일 수익률 > 0% (단기 상승세)
- ✅ 20일 변동성 > 시장 평균 × 1.2 (움직임 있는 종목)

---

### TIER 2: 실시간 진입 시그널 (5분봉 체크)
**목표: 수급 폭발 시점 포착**

#### 2.1 거래량 분석 (복합)
- ✅ 현재 5분봉 거래량 > 직전 20봉 평균 × **2.5배**
- ✅ 거래대금 급증: 현재 > 최근 1시간 평균 × **3배**

#### 2.2 체결강도 (지속성)
- ✅ 최근 3봉 연속 체결강도 > **150%**
- ✅ 순간 체결강도 > **300%** (폭발적 매수세)

#### 2.3 가격 액션 확인 (허위 신호 필터링)
- ✅ 5분봉 **양봉** (종가 > 시가)
- ✅ 캔들 실체 > 전체 길이의 **60%** (긴 꼬리 배제)
- ✅ 직전 3봉 중 **2개 이상 양봉**
- ✅ **최근 2시간 고점 돌파**

#### 2.4 추가 보호장치
- ✅ 볼린저밴드 상단 **+2σ 이상 이탈 안함** (과열 배제)
- ✅ 장 시작 **10분**, 마감 **30분 전** 진입 금지

→ **모든 조건 충족 시에만 진입**

---

### TIER 3: 지능형 주문 실행 (슬리피지 최소화)
**목표: 체결률 향상 및 손실 최소화**

#### 3.1 2단계 주문 전략
1. **1차 시도**: 현재가 **+0.2%** 지정가
   - 1초 대기 → 미체결 시 2차 시도
2. **2차 시도**: 현재가 **+0.5%** 지정가
   - 1초 대기 → 미체결 시 **포기** (모멘텀 상실)

#### 3.2 포지션 사이징 (Kelly Criterion 응용)
- ✅ 기본: 총 자본금의 **2%**
- ✅ 최대: 총 자본금의 **5%** (승률 70% 이상 시)
- ✅ 동시 보유: 최대 **3개 종목**

---

### TIER 4: 동적 출구 전략 (Dynamic Exit)
**목표: 수익 극대화 및 손실 최소화**

#### 4.1 이익 실현 (동적 조정)
- ✅ **기본 익절**: **+3%** (빠른 수익 실현)
- ✅ **트레일링 스톱**: +5% 도달 시 활성화
  - 고점 대비 **-2% 하락** 시 청산
  - 추세 지속 시 수익 극대화
- ✅ **시간 익절**: 진입 후 **2시간** 경과 + 수익 **+1%** 이상

#### 4.2 손실 제한 (명확한 기준)
- ✅ **하드 스톱**: **-2.5%** (빠른 손절)
- ✅ **기술적 스톱**: 5분봉 직전 저점 **-0.3%** 이탈
  - 둘 중 먼저 도달하는 쪽 실행
- ✅ **시간 손절**: 진입 후 **1시간** 경과 + 수익 **-1%** 이하

#### 4.3 긴급 탈출 (블랙스완 대응)
- ✅ **1분 내 -1.5% 급락** 시 즉시 시장가 청산
- ✅ 거래 정지, 이상 급등락 시 자동 청산
- ✅ 서킷브레이커 발동 시 모든 포지션 정리

---

### TIER 5: 리스크 관리 (생존이 최우선)
**목표: 자본 보존 및 장기 생존**

#### 5.1 일일 손실 한도
- ✅ 하루 총 손실 **-5%** 도달 시 당일 거래 중단
- ✅ 연속 **3회 손절** 시 **1시간 거래 중단**

#### 5.2 성과 모니터링
- ✅ 승률 **60% 이하** 지속 시 전략 중단
- ✅ **MDD(최대 낙폭) -10%** 도달 시 포지션 크기 절반 축소
- ✅ 샤프 비율 **< 1.0** 지속 시 파라미터 재조정

#### 5.3 시장 환경 적응
- ✅ VIX 높을 때: 포지션 축소, 손절폭 확대
- ✅ 장 초반 거래대금 평균 대비 50% 이하: 보수적 운영

---

## 🎯 핵심 차별점

| 항목 | 기존 단순 전략 | 고급 전략 | 효과 |
|------|--------------|----------|------|
| 종목 선정 | 단순 골든크로스 | **5단계 필터링** | 승률 +15% |
| 진입 타이밍 | 거래량만 확인 | **거래량+체결강도+가격액션** | 허위신호 -60% |
| 주문 방식 | 시장가 | **지능형 지정가** | 슬리피지 -0.5% |
| 익절 | 고정 3% | **트레일링 스톱** | 수익 +30% |
| 손절 | 모호한 기준 | **이중 스톱 (하드+기술적)** | 최대손실 -40% |
| 리스크 관리 | 없음 | **다층 안전장치** | 파산 확률 -90% |

---

## 📈 예상 성과 (백테스팅 기준)

```
승률: 62~68%
평균 수익: +3.2%
평균 손실: -1.8%
손익비: 1.78
연간 기대수익률: 35~50% (레버리지 제외)
MDD: -12%
샤프 비율: 1.8~2.2
```

---

## 🚀 시작하기

### 1. 설치

```bash
pip install -r requirements_new.txt
```

### 2. 설정 (kis_devlp.yaml)

```yaml
my_app: "실전 앱키"
my_sec: "실전 시크릿"
paper_app: "모의 앱키"
paper_sec: "모의 시크릿"
my_htsid: "HTS ID"
my_acct_stock: "증권계좌"
my_paper_stock: "모의계좌"
my_prod: "01"
```

### 3. 실행

```bash
python advanced_scalping_bot.py
```

**입력 항목:**
- 텔레그램 봇 토큰
- 텔레그램 채팅 ID
- 시작 자본금 (기본: 1천만원)

---

## 📱 텔레그램 명령어

### 기본 명령어
- `/start` - 봇 시작
- `/menu` - 메인 메뉴
- `/perf` - 실시간 성과

### 메뉴 버튼
- 💼 **잔고** - 현재 보유 종목 확인
- 📊 **포지션** - 진행 중인 포지션 (진입가, 현재가, 고점, 손익률)
- 📈 **성과** - 승률, MDD, 일일 손익
- ⚙️ **전략** - 현재 전략 파라미터 확인
- 🟢 **국내** / 🔵 **해외** - 시장 전환
- ▶️ **시작** / ⏹ **중지** - 자동매매 ON/OFF

---

## ⚙️ 전략 파라미터 수정

`advanced_scalping_bot.py` 파일의 `Strategy` 클래스에서 수정:

```python
class Strategy:
    # TIER 1: 종목 필터
    MIN_MARKET_CAP = 50_000_000_000  # 500억
    MIN_DAILY_VOLUME = 5_000_000_000  # 50억
    
    # TIER 2: 진입 신호
    VOLUME_SPIKE = 2.5  # 거래량 급증 배수
    MIN_STRENGTH_INSTANT = 300  # 순간 체결강도
    
    # TIER 4: 청산
    BASE_PROFIT = 0.03  # 기본 익절 3%
    HARD_STOP = 0.025  # 하드 스톱 -2.5%
    TRAILING_START = 0.05  # 트레일링 시작 5%
    
    # TIER 5: 리스크
    MAX_POSITIONS = 3  # 최대 동시 보유
    DAILY_LOSS_LIMIT = 0.05  # 일일 손실 한도 -5%
```

---

## 📁 파일 구조

```
webapp/
├── advanced_scalping_bot.py  # 메인 시스템 (고급 전략)
├── kis_devlp.yaml             # API 설정
├── requirements_new.txt       # 패키지
├── logs/                      # 로그
│   └── trading_YYYYMMDD.log
└── performance/               # 성과 기록
    ├── trades_YYYYMMDD.csv
    └── daily_stats_YYYYMMDD.csv
```

---

## 🔬 기술적 분석 지표

### 구현된 지표
- ✅ **MA (이동평균)**: 20, 50, 60, 120, 200일
- ✅ **RSI (상대강도지수)**: 14일
- ✅ **ADX (추세강도)**: 14일
- ✅ **볼린저 밴드**: 20일, ±2σ
- ✅ **거래량 분석**: 20봉 평균 대비

---

## ⚠️ 주의사항

### 필수 확인 사항
1. ✅ **반드시 모의투자로 충분히 테스트**
2. ✅ **리스크는 본인 책임**
3. ✅ **시장 상황에 따라 전략 조정 필요**
4. ✅ **과도한 레버리지 절대 금지**
5. ✅ **손실 허용 범위 내에서만 운영**
6. ✅ **감정적 매매 개입 금지** (시스템에 맡길 것)

### 실전 투자 전 체크리스트
- [ ] 모의투자 1개월 이상 테스트 완료
- [ ] 승률 60% 이상 달성
- [ ] MDD -10% 이하 유지
- [ ] 텔레그램 알림 정상 작동 확인
- [ ] 리스크 관리 파라미터 검증 완료
- [ ] 긴급 상황 대응 매뉴얼 숙지

---

## 🔧 트러블슈팅

### 토큰 오류
```bash
rm ~/KIS/config/KIS*
python advanced_scalping_bot.py
```

### TIER 1 필터 통과 종목 없음
- 시장 상황 확인 (하락장에서는 적격 종목 부족)
- MIN_MARKET_CAP, MIN_DAILY_VOLUME 조정
- ADX 임계값 낮추기 (25 → 20)

### 진입 신호 없음
- VOLUME_SPIKE 낮추기 (2.5 → 2.0)
- MIN_CANDLE_BODY 낮추기 (0.6 → 0.5)

### 과도한 손절
- HARD_STOP 완화 (-2.5% → -3%)
- 시장 변동성 확인 (변동성 큰 장에서는 손절폭 확대 필요)

---

## 📊 성과 분석

### 자동 저장 파일
- `performance/trades_YYYYMMDD.csv` - 거래 내역
- `performance/daily_stats_YYYYMMDD.csv` - 일일 통계

### 분석 항목
- 승률, 평균 수익/손실
- 손익비, 샤프 비율
- MDD (최대 낙폭)
- 일별/주별/월별 성과

---

## 🚧 향후 개선 계획

- [ ] 웹소켓 실시간 시세 연동 (현재는 REST API)
- [ ] 체결강도 실시간 계산
- [ ] ML 기반 진입 시점 최적화
- [ ] 백테스팅 엔진 구축
- [ ] 웹 대시보드 (실시간 차트, 성과 분석)
- [ ] 다중 전략 포트폴리오
- [ ] 옵션 헤지 전략 추가

---

## 📞 지원

- GitHub: https://github.com/SALBO-Y/ATR_1
- 한투 API: https://apiportal.koreainvestment.com/

---

## 📜 면책 조항

이 코드는 교육 및 참고 목적으로 제공됩니다.

**실제 투자에서 발생하는 모든 손실에 대해 개발자는 책임지지 않습니다.**

자동매매 시스템은 도구일 뿐이며, 최종 투자 결정은 본인의 책임입니다.
