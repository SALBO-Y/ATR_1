# 한국투자증권 자동시스템트레이딩 매매 프로그램

## 📋 개요

한국투자증권 Open API를 활용한 자동매매 시스템입니다. 조건검색식 기반으로 종목을 스캔하고, 설정한 전략에 따라 자동으로 매수/매도를 실행합니다.

### 주요 기능

1. **조건검색식 기반 매매**: HTS에 저장된 조건검색식을 활용하여 종목 필터링
2. **실시간 체결통보**: WebSocket을 통한 실시간 체결 알림 수신
3. **텔레그램 알림**: 매수/매도/체결/잔고 정보를 텔레그램으로 실시간 알림
4. **자동 손익관리**: 익절/손절 비율 설정을 통한 자동 매도
5. **예외처리**: 토큰 갱신, API 오류, 네트워크 오류 등 자동 복구
6. **코스피/코스닥 지원**: 양 시장 모두 거래 가능

## 📁 파일 구조

```
kis_auto_trading_system.py  # 단일 파일 자동매매 시스템
kis_devlp.yaml              # API 설정 파일 (개인정보 입력 필요)
kis_auto_trading.log        # 로그 파일 (자동 생성)
README_AUTO_TRADING.md      # 본 문서
```

## 🚀 설치 및 설정

### 1. 필수 패키지 설치

```bash
pip install pandas requests websockets pyyaml pycryptodome
```

또는 uv 사용 시:

```bash
uv pip install pandas requests websockets pyyaml pycryptodome
```

### 2. kis_devlp.yaml 설정

프로젝트 루트에 있는 `kis_devlp.yaml` 파일을 열어 본인의 정보를 입력합니다:

```yaml
# 실전투자
my_app: "실전투자 앱키"
my_sec: "실전투자 앱시크릿"

# 모의투자
paper_app: "모의투자 앱키"
paper_sec: "모의투자 앱시크릿"

# HTS ID
my_htsid: "사용자 HTS ID"

# 계좌번호 앞 8자리
my_acct_stock: "증권계좌 8자리"
my_paper_stock: "모의투자 증권계좌 8자리"

# 계좌번호 뒤 2자리
my_prod: "01"  # 종합계좌
```

### 3. 조건검색식 설정

HTS(efriend Plus)에서 조건검색식을 설정합니다:

1. HTS 실행 → [0110] 조건검색 메뉴 이동
2. 원하는 매매 조건을 설정하여 조건검색식 생성
3. **중요**: 왼쪽 하단의 "사용자조건 서버저장" 버튼 클릭
4. 조건검색식 번호(seq) 확인 (0부터 시작)

### 4. 텔레그램 봇 설정 (선택사항)

텔레그램 알림을 받으려면:

1. 텔레그램에서 @BotFather 검색
2. `/newbot` 명령어로 봇 생성
3. 봇 토큰 저장
4. 봇과 대화 시작
5. https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getUpdates 접속하여 Chat ID 확인

## 💻 사용 방법

### 기본 실행

```bash
python kis_auto_trading_system.py
```

### 실행 시 설정 항목

프로그램 실행 시 다음 항목들을 입력합니다:

1. **서버 구분**: 
   - `vps`: 모의투자 (테스트용, 권장)
   - `prod`: 실전투자 (실제 거래)

2. **계좌 상품코드**: 
   - `01`: 위탁계좌 (기본값)

3. **텔레그램 설정** (선택):
   - 봇 토큰
   - 채팅 ID

4. **조건검색식 번호**: 
   - HTS에 저장한 조건검색식 번호 (0부터 시작)

5. **매매 파라미터**:
   - 종목당 매수금액 (기본: 1,000,000원)
   - 익절 비율 (기본: 2%)
   - 손절 비율 (기본: 1%)
   - 최대 보유 종목 수 (기본: 5개)
   - 상태 체크 주기 (기본: 10초)

### 실행 예시

```
============================================================
한국투자증권 자동시스템트레이딩 매매 프로그램
============================================================

■ 환경 설정
서버 구분 (prod: 실전, vps: 모의) [vps]: vps
계좌 상품코드 (01: 위탁계좌) [01]: 01

■ 텔레그램 설정 (선택사항)
텔레그램 봇 토큰 (없으면 Enter): 123456789:ABCdefGHIjklMNOpqrSTUvwxYZ
텔레그램 채팅 ID (없으면 Enter): 987654321

■ 조건검색 설정
조건검색식 번호 (0부터 시작) [0]: 0

■ 매매 파라미터 설정
종목당 매수금액 (원) [1000000]: 1000000
익절 비율 (%) [2.0]: 3.0
손절 비율 (%) [1.0]: 1.5
최대 보유 종목 수 [5]: 3
상태 체크 주기 (초) [10]: 10
```

## 📊 시스템 동작 원리

### 1. 초기화 단계

```
인증 토큰 발급 → 웹소켓 접속키 발급 → 조건검색 종목 로딩 → 현재 잔고 확인
```

### 2. 매매 루프

```
[5분마다] 조건검색 종목 업데이트
    ↓
[30초마다] 잔고 및 포지션 업데이트
    ↓
[10초마다] 매도 신호 체크
    ↓ (익절/손절 조건 충족 시)
매도 주문 실행
    ↓
[10초마다] 매수 신호 체크
    ↓ (조건 충족 시)
매수 주문 실행
```

### 3. 체결통보 처리

```
WebSocket으로 실시간 체결통보 수신
    ↓
체결 정보 파싱 및 로깅
    ↓
텔레그램 알림 전송
    ↓
포지션 정보 업데이트
```

## 🎯 매매 전략 상세

### 매수 조건

다음 조건을 **모두** 만족할 때 매수 실행:

1. 조건검색식에 포함된 종목
2. 아직 보유하지 않은 종목
3. 최대 보유 종목 수 미만

### 매도 조건

다음 조건 중 **하나라도** 만족할 때 매도 실행:

1. **익절**: 수익률이 설정한 익절 비율 이상
2. **손절**: 손실률이 설정한 손절 비율 이하

### 주문 방식

- 모든 주문은 **시장가**로 실행
- 매수 시 매수가능수량 전량 매수
- 매도 시 보유수량 전량 매도

## 📱 텔레그램 알림 종류

### 1. 시스템 알림

- **시작 알림**: 시스템 시작 시
- **종료 알림**: 시스템 종료 시
- **오류 알림**: 예외 발생 시

### 2. 거래 알림

- **주문 알림**: 주문 접수 시
- **체결 알림**: 체결 완료 시
- **잔고 알림**: 잔고 업데이트 시 (30초마다)

## 🛡️ 예외처리 및 안전장치

### 1. 토큰 관리

- Access Token 자동 발급/갱신 (유효기간 1일)
- 토큰 만료 시 자동 재발급
- 5분당 1회 발급 제한 준수

### 2. API 호출 제한

- 초당 거래건수 제한 준수
- 연속 호출 시 적절한 지연 시간 적용
- 오류 발생 시 재시도 로직

### 3. 오류 복구

- `EGW00201` (초당 거래건수 초과) → 0.5초 대기 후 재시도
- `EGW00123` (토큰 만료) → 자동 토큰 재발급
- 네트워크 오류 → 10초 대기 후 재시도

## 📝 로그 확인

시스템 실행 중 모든 활동은 `kis_auto_trading.log` 파일에 기록됩니다:

```bash
# 로그 실시간 확인
tail -f kis_auto_trading.log

# 오류 로그만 확인
grep ERROR kis_auto_trading.log

# 체결 로그만 확인
grep "체결" kis_auto_trading.log
```

## ⚠️ 주의사항

### 1. 모의투자로 먼저 테스트

실전투자 전에 **반드시** 모의투자 환경에서 충분히 테스트하세요:

```python
svr = "vps"  # 모의투자
```

### 2. 조건검색식 관리

- 조건검색식 수정 시 HTS에서 "사용자조건 서버저장" 필수
- API는 조건당 최대 100건으로 제한됨
- 조건검색식 결과가 0개인 경우 오류 메시지 발생

### 3. 매매 시간

- 정규장 시간: 09:00 ~ 15:30
- 시간외 단일가: 08:30 ~ 08:40, 15:40 ~ 16:00
- 장 종료 시 시스템 수동 종료 권장

### 4. 리스크 관리

- 종목당 매수금액을 보수적으로 설정
- 최대 보유 종목 수 제한 설정
- 손절 비율 반드시 설정

### 5. API 제한사항

- WebSocket은 최대 40개 종목 동시 구독 제한
- 주문은 REST API만 가능 (WebSocket 불가)
- 실시간 전체 종목 시세 구독 불가

## 🔧 커스터마이징

### 1. 매매 전략 수정

`AutoTradingSystem` 클래스의 다음 메서드를 수정:

- `check_buy_signal()`: 매수 조건 변경
- `check_sell_signal()`: 매도 조건 변경

### 2. 알림 메시지 커스터마이징

`TelegramBot` 클래스의 메시지 메서드 수정:

- `send_order_alert()`: 주문 알림 포맷
- `send_execution_alert()`: 체결 알림 포맷
- `send_balance_alert()`: 잔고 알림 포맷

### 3. 체크 주기 변경

`trading_params` 딕셔너리 수정:

```python
trading_params = {
    "check_interval": 5,  # 5초마다 체크
}
```

## 🐛 문제 해결

### 토큰 발급 오류

```
Error: Access Token 발급 실패
```

**해결방법**:
- `kis_devlp.yaml` 파일의 앱키, 앱시크릿 확인
- 한국투자증권 홈페이지에서 API 서비스 신청 상태 확인

### 조건검색 오류

```
Error: 조회가 계속 됩니다. (다음을 누르십시오.)
```

**해결방법**:
- HTS [0110] 조건검색 화면에서 "사용자조건 서버저장" 클릭

### WebSocket 연결 오류

```
Error: No close frame received
```

**해결방법**:
- `kis_devlp.yaml` 파일의 HTS ID 확인
- 방화벽 설정 확인

### 주문 실패

```
Error: 매수가능 수량 없음
```

**해결방법**:
- 잔고 확인
- 종목당 매수금액 조정

## 📚 참고 자료

- [한국투자증권 Open API 포털](https://apiportal.koreainvestment.com/)
- [API 사용 가이드](https://apiportal.koreainvestment.com/about-howto)
- [GitHub 샘플 코드](https://github.com/koreainvestment/open-trading-api)
- [FAQ](https://apiportal.koreainvestment.com/faq)

## 📞 문의

- 한국투자증권 Open API 고객센터: 1544-5000
- [Open API 챗봇](https://chatgpt.com/g/g-68b920ee7afc8191858d3dc05d429571)

## 📄 라이선스

본 샘플 코드는 참고용으로 제공되며, 이를 활용하여 제작한 프로그램으로 인한 손해에 대해서는 당사에서 책임지지 않습니다.

## 🔄 버전 히스토리

- **v1.0.0** (2026-01-12)
  - 초기 버전 릴리스
  - 조건검색식 기반 자동매매 기능
  - 실시간 체결통보 WebSocket 연동
  - 텔레그램 알림 기능
  - 익절/손절 자동 매도 기능
  - 예외처리 및 로깅 기능

---

**면책조항**: 본 프로그램은 교육 및 참고 목적으로 제공됩니다. 실제 투자에 사용하기 전에 충분한 테스트를 거치시고, 투자 판단과 그에 따른 손익은 사용자의 책임입니다.
